# Use Python slim base image
FROM python:3.10-slim

# Install system dependencies required by PyTorch CPU
RUN apt-get update && \
    apt-get install -y git libgomp1 && \
    rm -rf /var/lib/apt/lists/*

# Install Python dependencies
RUN pip install --no-cache-dir torch transformers

# Pre-download the model + tokenizer into /models (offline-safe)
WORKDIR /tmp
COPY preload_models.py /tmp/preload_models.py
RUN python3 preload_models.py

# Tell HuggingFace transformers to always use the local /models directory
ENV TRANSFORMERS_CACHE=/models

# Set working directory for the action
WORKDIR /action

# Copy your action code
COPY action.py /action/action.py

# Create OpenWhisk exec wrapper
RUN echo "#!/usr/bin/env bash" > /action/exec && \
    echo "python /action/action.py" >> /action/exec && \
    chmod +x /action/exec

# Entrypoint for OpenWhisk
ENTRYPOINT ["/action/exec"]
